on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    name: build
    runs-on: ubuntu-latest
    steps:
      - name: setup-mkosi
        uses: systemd/mkosi@main
      - name: checkout repo
        uses: actions/checkout@main
      - name: Decrypt large secret
        run: ./scripts/decrypt_secrets.sh
        env:
          SECRET_PASSPHRASE: ${{ secrets.SECRET_PASSPHRASE }}
      - name: build
        run: |
          cp $HOME/secrets/mkosi.crt .
          cp $HOME/secrets/mkosi.key .
          sha256sum ./mkosi.crt
          sha256sum ./mkosi.key
          chmod 600 ./mkosi.key
          mkosi build --compress-output=yes --debug

      - name: list artifacts
        run: |
          ls -la mkosi.output
      - name: Upload Artifact - Image
        uses: actions/upload-artifact@v4
        with:
          name: SNOW.raw.zst
          path: mkosi.output/SNOW_*.raw.zst
